<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRO-NEWS | Professional Nashriyot Tizimi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #1e40af; /* To'q ko'k */
            --bg: #f8fafc;
            --text-main: #0f172a;
            --text-sub: #475569;
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text-main); }

        /* HEADER */
        header {
            background: var(--white);
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-family: 'Merriweather', serif; font-size: 1.8rem; color: var(--brand); font-weight: 700; text-decoration: none; }
        
        .admin-trigger { 
            background: #f1f5f9; padding: 10px 20px; border-radius: 8px; 
            font-weight: 600; cursor: pointer; transition: 0.2s; border: none;
        }
        .admin-trigger:hover { background: #e2e8f0; }

        /* MAIN FEED */
        .container { max-width: 900px; margin: 30px auto; padding: 0 15px; }
        
        .article-card {
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .article-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .article-img { width: 100%; height: 450px; object-fit: cover; background: #ddd; }
        
        .article-content { padding: 25px; }
        .article-tag { color: var(--brand); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 10px; display: block; }
        .article-title { font-family: 'Merriweather', serif; font-size: 2rem; line-height: 1.3; margin-bottom: 15px; }
        .article-body { color: var(--text-sub); line-height: 1.7; font-size: 1.1rem; }

        /* SIDE ADMIN DRAWER (Boshqaruv paneli) */
        .admin-drawer {
            position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
            background: var(--white); box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 1000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 30px; overflow-y: auto;
        }
        .admin-drawer.open { right: 0; }
        
        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* FORM */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }
        input, textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-size: 14px;
        }
        input:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); }
        
        .save-btn {
            width: 100%; padding: 15px; background: var(--brand); color: white;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .save-btn:hover { background: #1e3a8a; }

        /* LOADER */
        #loading-overlay { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); 
            display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .loader-spin { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ADMIN TOOLS IN FEED */
        .feed-admin-tools {
            display: none; gap: 10px; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px;
        }
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 0.8rem; }
        .btn-edit { background: #dbeafe; color: #1e40af; }
        .btn-delete { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="loader-spin"></div></div>

<header>
    <a href="#" class="logo">PRO-NEWS</a>
    <button class="admin-trigger" onclick="app.toggleAdmin()">BOSHQARUV ⚙️</button>
</header>

<div class="admin-drawer" id="drawer">
    <div class="drawer-header">
        <h2>Boshqaruv</h2>
        <button onclick="app.toggleAdmin()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>

    <div class="form-group">
        <input type="hidden" id="post-id">
        <label>Sarlavha</label>
        <input type="text" id="post-title" placeholder="Maqola sarlavhasi...">
    </div>
    <div class="form-group">
        <label>Asosiy matn</label>
        <textarea id="post-body" rows="8" placeholder="Maqola mazmuni..."></textarea>
    </div>
    <div class="form-group">
        <label>Rasm yuklash</label>
        <input type="file" id="post-file" accept="image/*" onchange="app.handleImage(this)">
    </div>
    <div id="img-preview" style="margin-bottom: 20px;"></div>
    <button class="save-btn" onclick="app.saveData()">NASHIR QILISH</button>
</div>

<div class="container" id="news-feed">
    </div>

<script>
    const API = "https://sheetdb.io/api/v1/9vpxgyb4jfycs";
    const ADMIN_PASS = "1997"; // Parolni o'zgartirishingiz mumkin

    const app = {
        isAuthorized: false,
        imgCache: "",

        toggleAdmin: function() {
            if(!this.isAuthorized) {
                const pass = prompt("Admin parolini kiriting:");
                if(pass !== ADMIN_PASS) return alert("Parol noto'g'ri!");
                this.isAuthorized = true;
                this.renderAdminTools();
            }
            document.getElementById('drawer').classList.toggle('open');
        },

        handleImage: function(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const w = 1200; const h = img.height * (w / img.width);
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    this.imgCache = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('img-preview').innerHTML = `<img src="${this.imgCache}" style="width:100%; border-radius:8px;">`;
                }
            };
            reader.readAsDataURL(file);
        },

        saveData: async function() {
            const t = document.getElementById('post-title').value;
            const b = document.getElementById('post-body').value;
            const id = document.getElementById('post-id').value;

            if(!t || !b) return alert("Ma'lumotlar chala!");
            
            document.getElementById('loading-overlay').style.display = 'flex';

            if(id) { await fetch(`${API}/id/${id}`, { method: 'DELETE' }); }

            const payload = {
                data: [{
                    id: id || Date.now(),
                    title: t,
                    body: b,
                    image: this.imgCache,
                    date: new Date().toLocaleDateString('uz-UZ')
                }]
            };

            await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            location.reload();
        },

        fetch: async function() {
            try {
                const res = await fetch(API);
                const data = await res.json();
                const feed = document.getElementById('news-feed');
                
                feed.innerHTML = data.reverse().map(item => `
                    <div class="article-card">
                        ${item.image ? `<img src="${item.image}" class="article-img">` : ''}
                        <div class="article-content">
                            <span class="article-tag">YANGILIKLAR • ${item.date}</span>
                            <h2 class="article-title">${item.title}</h2>
                            <p class="article-body">${item.body}</p>
                            
                            <div class="feed-admin-tools" id="tools-${item.id}">
                                <button class="btn-sm btn-edit" onclick="app.editPrep('${item.id}', '${item.title}', '${encodeURIComponent(item.body)}', '${item.image}')">Tahrirlash</button>
                                <button class="btn-sm btn-delete" onclick="app.deletePost('${item.id}')">O'chirish</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                if(this.isAuthorized) this.renderAdminTools();
            } catch (e) { console.error("API error"); }
        },

        renderAdminTools: function() {
            const tools = document.querySelectorAll('.feed-admin-tools');
            tools.forEach(t => t.style.display = 'flex');
        },

        editPrep: function(id, title, body, img) {
            document.getElementById('drawer').classList.add('open');
            document.getElementById('post-id').value = id;
            document.getElementById('post-title').value = title;
            document.getElementById('post-body').value = decodeURIComponent(body);
            this.imgCache = img;
            document.getElementById('img-preview').innerHTML = `<img src="${img}" style="width:100%; border-radius:8px;">`;
            window.scrollTo(0, 0);
        },

        deletePost: async function(id) {
            if(confirm("Ushbu maqolani o'chirishni xohlaysizmi?")) {
                document.getElementById('loading-overlay').style.display = 'flex';
                await fetch(`${API}/id/${id}`, { method: 'DELETE' });
                location.reload();
            }
        }
    };

    window.onload = () => app.fetch();
</script>

</body>
</html>
